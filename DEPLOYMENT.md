# CodeArena Production Deployment Guide

This guide covers deploying the CodeArena platform to production with separate hosting for frontend and backend.

## Architecture Overview

- **Frontend**: Next.js application (codearena-web)
- **Backend**: Express.js API server (codearena-server)
- **Database**: PostgreSQL
- **Code Execution**: Docker containers (requires Docker on backend server)

---

## Option 1: Vercel (Frontend) + Railway/Render (Backend) - Recommended

### Frontend Deployment (Vercel)

**1. Prepare the Frontend**

```bash
cd codearena-web

# Create vercel.json for configuration
cat > vercel.json << 'EOF'
{
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "env": {
    "NEXT_PUBLIC_API_URL": "@api_url"
  }
}
EOF
```

**2. Deploy to Vercel**

```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Deploy
vercel --prod
```

**3. Set Environment Variables in Vercel Dashboard**
- `NEXT_PUBLIC_API_URL`: Your backend API URL (e.g., `https://your-api.railway.app`)

---

### Backend Deployment (Railway)

**1. Prepare the Backend**

Create `railway.json`:
```json
{
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "node server.js",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

**2. Deploy to Railway**

```bash
# Install Railway CLI
npm i -g @railway/cli

# Login
railway login

# Initialize project
cd codearena-server
railway init

# Add PostgreSQL database
railway add --database postgresql

# Deploy
railway up
```

**3. Set Environment Variables in Railway Dashboard**

```env
NODE_ENV=production
PORT=3000
DATABASE_URL=<auto-generated-by-railway>
JWT_SECRET=<generate-strong-secret>
GOOGLE_CLIENT_ID=<your-google-oauth-client-id>
GOOGLE_CLIENT_SECRET=<your-google-oauth-secret>
GITHUB_CLIENT_ID=<your-github-oauth-client-id>
GITHUB_CLIENT_SECRET=<your-github-oauth-secret>
CALLBACK_URL=https://your-api.railway.app
FRONTEND_URL=https://your-app.vercel.app
GROQ_API_KEY=<your-groq-api-key>
```

**4. Docker Setup on Railway**

Railway doesn't support Docker-in-Docker by default. You have two options:

**Option A: Use Railway's Docker Support**
- Enable Docker in Railway project settings
- Ensure your Dockerfile is in the root of codearena-server

**Option B: Use External Code Execution Service**
- Deploy code execution to a separate VPS with Docker
- Update backend to call external execution API

---

## Option 2: VPS Deployment (DigitalOcean, AWS EC2, etc.)

### Prerequisites
- Ubuntu 22.04 LTS server
- Domain name (optional but recommended)
- SSH access

### 1. Server Setup

```bash
# SSH into your server
ssh root@your-server-ip

# Update system
apt update && apt upgrade -y

# Install Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# Install PostgreSQL
apt install -y postgresql postgresql-contrib

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Install Nginx
apt install -y nginx

# Install PM2 for process management
npm install -g pm2
```

### 2. Database Setup

```bash
# Switch to postgres user
sudo -u postgres psql

# Create database and user
CREATE DATABASE codearena;
CREATE USER codearena_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE codearena TO codearena_user;
\q
```

### 3. Clone and Setup Backend

```bash
# Create app directory
mkdir -p /var/www/codearena
cd /var/www/codearena

# Clone your repository
git clone <your-repo-url> .

# Setup backend
cd codearena-server
npm install --production

# Create .env file
cat > .env << 'EOF'
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://codearena_user:your_secure_password@localhost:5432/codearena
JWT_SECRET=your_jwt_secret_here
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_secret
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_secret
CALLBACK_URL=https://api.yourdomain.com
FRONTEND_URL=https://yourdomain.com
GROQ_API_KEY=your_groq_api_key
EOF

# Run migrations
npx sequelize-cli db:migrate

# Build Docker sandbox image
cd ../docker
docker build -t codearena-sandbox .

# Start backend with PM2
cd ../codearena-server
pm2 start server.js --name codearena-api
pm2 save
pm2 startup
```

### 4. Setup Frontend

```bash
cd /var/www/codearena/codearena-web

# Install dependencies
npm install

# Create .env.local
cat > .env.local << 'EOF'
NEXT_PUBLIC_API_URL=https://api.yourdomain.com
EOF

# Build
npm run build

# Start with PM2
pm2 start npm --name codearena-web -- start
pm2 save
```

### 5. Nginx Configuration

```bash
# Create backend config
cat > /etc/nginx/sites-available/codearena-api << 'EOF'
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
EOF

# Create frontend config
cat > /etc/nginx/sites-available/codearena-web << 'EOF'
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# Enable sites
ln -s /etc/nginx/sites-available/codearena-api /etc/nginx/sites-enabled/
ln -s /etc/nginx/sites-available/codearena-web /etc/nginx/sites-enabled/

# Test and reload Nginx
nginx -t
systemctl reload nginx
```

### 6. SSL with Let's Encrypt

```bash
# Install Certbot
apt install -y certbot python3-certbot-nginx

# Get SSL certificates
certbot --nginx -d yourdomain.com -d www.yourdomain.com
certbot --nginx -d api.yourdomain.com

# Auto-renewal is set up automatically
```

---

## Option 3: Docker Compose Deployment

Create `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: codearena
      POSTGRES_USER: codearena_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  backend:
    build: ./codearena-server
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://codearena_user:${DB_PASSWORD}@postgres:5432/codearena
      JWT_SECRET: ${JWT_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      CALLBACK_URL: ${CALLBACK_URL}
      FRONTEND_URL: ${FRONTEND_URL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - postgres
    restart: always

  frontend:
    build: ./codearena-web
    ports:
      - "3001:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${API_URL}
    depends_on:
      - backend
    restart: always

volumes:
  postgres_data:
```

Deploy:
```bash
docker-compose -f docker-compose.prod.yml up -d
```

---

## Post-Deployment Checklist

- [ ] Update OAuth redirect URIs in Google/GitHub console
- [ ] Set up database backups
- [ ] Configure monitoring (e.g., UptimeRobot, Sentry)
- [ ] Set up logging (PM2 logs, CloudWatch, etc.)
- [ ] Enable CORS properly in backend
- [ ] Test all features in production
- [ ] Set up CI/CD pipeline (GitHub Actions)
- [ ] Configure rate limiting
- [ ] Set up CDN for static assets (Cloudflare)

---

## Updating the Application

### Vercel + Railway
```bash
# Frontend
cd codearena-web
git push origin main  # Auto-deploys on Vercel

# Backend
cd codearena-server
railway up
```

### VPS
```bash
ssh root@your-server-ip
cd /var/www/codearena

# Pull latest changes
git pull

# Update backend
cd codearena-server
npm install
npx sequelize-cli db:migrate
pm2 restart codearena-api

# Update frontend
cd ../codearena-web
npm install
npm run build
pm2 restart codearena-web
```

---

## Monitoring & Maintenance

### Check Logs
```bash
# PM2 logs
pm2 logs codearena-api
pm2 logs codearena-web

# Nginx logs
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### Database Backup
```bash
# Backup
pg_dump -U codearena_user codearena > backup_$(date +%Y%m%d).sql

# Restore
psql -U codearena_user codearena < backup_20231121.sql
```

---

## Troubleshooting

### Docker Issues
- Ensure Docker socket is accessible: `ls -la /var/run/docker.sock`
- Check Docker permissions: `usermod -aG docker $USER`
- Verify sandbox image: `docker images | grep codearena-sandbox`

### Database Connection
- Test connection: `psql -U codearena_user -d codearena -h localhost`
- Check PostgreSQL status: `systemctl status postgresql`

### OAuth Issues
- Verify redirect URIs match exactly
- Check environment variables are set correctly
- Ensure HTTPS is enabled for production

---

## Recommended Services

- **Frontend**: Vercel (free tier available)
- **Backend**: Railway ($5/month) or Render (free tier)
- **Database**: Railway PostgreSQL or Supabase
- **Code Execution**: Separate VPS with Docker ($5-10/month)
- **Domain**: Namecheap, Google Domains
- **SSL**: Let's Encrypt (free)
- **Monitoring**: UptimeRobot (free), Sentry (free tier)
- **CDN**: Cloudflare (free)

---

## Cost Estimate

**Budget Option (~$10/month)**
- Vercel: Free
- Railway: $5/month (backend + database)
- DigitalOcean Droplet: $6/month (Docker execution)

**Production Option (~$30/month)**
- Vercel Pro: $20/month
- Railway: $10/month
- DigitalOcean: $12/month

---

For questions or issues, refer to the documentation of each service or create an issue in your repository.
